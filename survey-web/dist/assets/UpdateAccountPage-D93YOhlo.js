import{k as _,u as F,r as n,j as s,S as O,M as z}from"./index-pkM7sRJn.js";const B=()=>{const c="/api/v1",{id:d}=_(),u=F(),[r,h]=n.useState({username:"",email:"",roles:[]}),[N,k]=n.useState([]),[m,p]=n.useState({username:"",email:""}),[v,f]=n.useState(!1),[S,C]=n.useState(""),[w,T]=n.useState(""),[b,E]=n.useState(!1),[M,i]=n.useState(!1),[j,g]=n.useState("");n.useEffect(()=>{(async()=>{i(!0);try{const t=localStorage.getItem("token"),[a,o]=await Promise.all([fetch(`${c}/users/${d}`,{headers:{Authorization:`Bearer ${t}`}}),fetch(`${c}/roles`,{headers:{Authorization:`Bearer ${t}`}})]);if(a.status===401||o.status===401){g("jwt_error"),l("Thông báo","Phiên đăng nhập đã hết hạn, vui lòng đăng nhập lại.",!0),i(!1);return}const x=await a.json(),R=await o.json();h({username:x.username,email:x.email,roles:x.roles.map(U=>U.id)}),k(R)}catch{l("Lỗi","Có lỗi xảy ra khi tải dữ liệu.",!0)}finally{i(!1)}})()},[c,d]);const y=e=>{const{name:t,value:a}=e.target;h(o=>({...o,[t]:a})),p(o=>({...o,[t]:""}))},$=e=>{h(t=>{const a=t.roles.includes(e);return{...t,roles:a?t.roles.filter(o=>o!==e):[...t.roles,e]}})},A=()=>{const e={};return r.username.trim()||(e.username="Username không được để trống."),r.email.trim()||(e.email="Email không được để trống."),p(e),Object.keys(e).length===0},L=async()=>{if(A()){i(!0);try{const e=localStorage.getItem("token"),t=await fetch(`${c}/users`,{method:"PUT",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({id:d,username:r.username,email:r.email,roles:r.roles})}),a=await t.json();if(t.status===401){g(a.detail),l("Thông báo","Phiên đăng nhập đã hết hạn, vui lòng đăng nhập lại.",!0);return}r.username==localStorage.getItem("username")&&g("invalid_token"),a.message==="user_existed"?l("Thông báo","Tên đăng nhập đã được sử dụng.",!0):a.message==="email_existed"?l("Thông báo","Email đã được sử dụng.",!0):a.message==="updated"?l("Thành công","Cập nhật tài khoản thành công!",!1):l("Lỗi","Cập nhật không thành công.",!0)}catch{l("Lỗi","Có lỗi xảy ra khi cập nhật.",!0)}finally{i(!1)}}},I=()=>u(-1),l=(e,t,a)=>{C(e),T(t),E(a),f(!0)},P=()=>{f(!1),b||u(-1),(j==="invalid_token"||j==="jwt_error")&&(localStorage.removeItem("token"),localStorage.removeItem("username"),localStorage.removeItem("roles"),u("/"))};return s.jsxs("div",{className:"flex items-center justify-center min-h-screen p-4 bg-gray-100 relative",children:[M&&s.jsx("div",{className:"fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-50",children:s.jsx(O,{})}),s.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 w-full max-w-md",children:[s.jsx("h2",{className:"text-2xl font-bold mb-4 text-center text-gray-800",children:"Cập Nhật Tài Khoản"}),s.jsxs("div",{className:"mb-4",children:[s.jsx("label",{htmlFor:"username",className:"block font-medium text-gray-700 mb-1",children:"Username"}),s.jsx("input",{id:"username",name:"username",value:r.username,onChange:y,className:"w-full px-4 py-2 border rounded-lg",placeholder:"Nhập username"}),m.username&&s.jsx("p",{className:"text-red-500 text-sm mt-1",children:m.username})]}),s.jsxs("div",{className:"mb-4",children:[s.jsx("label",{htmlFor:"email",className:"block font-medium text-gray-700 mb-1",children:"Email"}),s.jsx("input",{id:"email",name:"email",value:r.email,onChange:y,className:"w-full px-4 py-2 border rounded-lg",placeholder:"Nhập email"}),m.email&&s.jsx("p",{className:"text-red-500 text-sm mt-1",children:m.email})]}),s.jsxs("div",{className:"mb-4",children:[s.jsx("label",{className:"block font-medium text-gray-700 mb-2",children:"Phân quyền"}),N.map(e=>s.jsxs("div",{className:"flex items-center mb-1",children:[s.jsx("input",{type:"checkbox",id:`role-${e.id}`,checked:r.roles.includes(e.id),onChange:()=>$(e.id),className:"mr-2"}),s.jsx("label",{htmlFor:`role-${e.id}`,children:e.name})]},e.id))]}),s.jsxs("div",{className:"flex justify-center gap-4 mt-6",children:[s.jsx("button",{onClick:L,className:"px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600",children:"Cập nhật"}),s.jsx("button",{onClick:I,className:"px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400",children:"Hủy"})]})]}),s.jsx(z,{isOpen:v,onClose:P,title:S,message:w,isError:b})]})};export{B as default};
